name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect which paths changed to conditionally run jobs
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      types: ${{ steps.filter.outputs.types }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'apps/backend/**'
            frontend:
              - 'apps/frontend/**'
            types:
              - 'packages/types/**'
            shared:
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'eslint.config.js'
              - '.prettierrc'

  # Build types package with content-aware caching
  build-types:
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.types == 'true' ||
      needs.changes.outputs.backend == 'true' ||
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.shared == 'true'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        id: setup
        with:
          restore-types: 'true'

      - name: Build types package
        if: steps.setup.outputs.types-cache-hit != 'true'
        run: pnpm --filter @tago-analysis-worker/types run build

      # Save types cache for other jobs
      - name: Save types dist cache
        if: steps.setup.outputs.types-cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: packages/types/dist
          key: ${{ runner.os }}-types-dist-${{ hashFiles('packages/types/src/**', 'packages/types/tsconfig.json', 'packages/types/package.json') }}

  # Format check - runs in parallel with build-types
  format-check:
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.types == 'true' ||
      needs.changes.outputs.backend == 'true' ||
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.shared == 'true'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Check code formatting
        run: pnpm format:check

  # Lint check - runs in parallel with build-types
  lint:
    runs-on: ubuntu-latest
    needs: changes
    if: |
      needs.changes.outputs.types == 'true' ||
      needs.changes.outputs.backend == 'true' ||
      needs.changes.outputs.frontend == 'true' ||
      needs.changes.outputs.shared == 'true'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run linter
        run: pnpm lint

  # Backend typecheck - runs after types are built
  typecheck-backend:
    runs-on: ubuntu-latest
    needs: [changes, build-types]
    if: |
      always() &&
      (needs.build-types.result == 'success' || needs.build-types.result == 'skipped') &&
      (needs.changes.outputs.backend == 'true' ||
       needs.changes.outputs.types == 'true' ||
       needs.changes.outputs.shared == 'true')
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          restore-types: 'true'

      - name: Typecheck backend
        working-directory: apps/backend
        run: pnpm typecheck

  # Backend tests - runs after types are built
  test-backend:
    runs-on: ubuntu-latest
    needs: [changes, build-types]
    if: |
      always() &&
      (needs.build-types.result == 'success' || needs.build-types.result == 'skipped') &&
      (needs.changes.outputs.backend == 'true' ||
       needs.changes.outputs.types == 'true' ||
       needs.changes.outputs.shared == 'true')
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          restore-types: 'true'

      - name: Run backend tests with coverage
        working-directory: apps/backend
        run: pnpm test:coverage

      - name: Report coverage
        if: always()
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          working-directory: ./apps/backend

  # Frontend build verification - runs after types are built
  build-frontend:
    runs-on: ubuntu-latest
    needs: [changes, build-types]
    if: |
      always() &&
      (needs.build-types.result == 'success' || needs.build-types.result == 'skipped') &&
      (needs.changes.outputs.frontend == 'true' ||
       needs.changes.outputs.types == 'true' ||
       needs.changes.outputs.shared == 'true')
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          restore-types: 'true'

      - name: Build frontend
        run: pnpm --filter frontend run build

  # Final status check - all required jobs must pass (or be skipped)
  ci-status:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: always()
    needs:
      [
        changes,
        format-check,
        lint,
        typecheck-backend,
        test-backend,
        build-frontend,
      ]

    steps:
      - name: Check CI status
        run: |
          echo "Job results:"
          echo "  changes: ${{ needs.changes.result }}"
          echo "  format-check: ${{ needs.format-check.result }}"
          echo "  lint: ${{ needs.lint.result }}"
          echo "  typecheck-backend: ${{ needs.typecheck-backend.result }}"
          echo "  test-backend: ${{ needs.test-backend.result }}"
          echo "  build-frontend: ${{ needs.build-frontend.result }}"

          # Helper function to check if result is acceptable
          check_result() {
            [[ "$1" == "success" ]] || [[ "$1" == "skipped" ]]
          }

          if ! check_result "${{ needs.changes.result }}" || \
             ! check_result "${{ needs.format-check.result }}" || \
             ! check_result "${{ needs.lint.result }}" || \
             ! check_result "${{ needs.typecheck-backend.result }}" || \
             ! check_result "${{ needs.test-backend.result }}" || \
             ! check_result "${{ needs.build-frontend.result }}"; then
            echo "CI checks failed!"
            exit 1
          fi
          echo "All CI checks passed!"

  # Trigger build-push if CI passed on main and there's a new version
  check-version:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: ci-status
    permissions:
      contents: read
      packages: read
    outputs:
      has-new-version: ${{ steps.check.outputs.HAS_NEW_VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for new versions
        id: check
        env:
          REGISTRY: ghcr.io
        run: |
          HAS_NEW_VERSION=false
          for app_path in ./apps/backend ./apps/frontend; do
            app_name=$(basename "$app_path")
            version=$(node -p "require('$app_path/package.json').version")
            image="${REGISTRY}/${{ github.repository }}/${app_name}:${version}"
            if ! docker manifest inspect "$image" >/dev/null 2>&1; then
              echo "${app_name} version ${version} is new"
              HAS_NEW_VERSION=true
            fi
          done
          echo "HAS_NEW_VERSION=$HAS_NEW_VERSION" >> $GITHUB_OUTPUT

  trigger-build:
    needs: check-version
    if: needs.check-version.outputs.has-new-version == 'true'
    uses: ./.github/workflows/build-push.yaml
    permissions:
      contents: read
      actions: read
      packages: write
      id-token: write
